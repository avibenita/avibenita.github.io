<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="page-title">Box Plot Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/annotations.js"></script>

  <style>
    :root {
      --surface-0: #0c1624; /* page background */
      --surface-1: #1a1f2e; /* cards / panels - warmer dark gray-blue */
      --surface-2: #242938; /* chart / results boxes */
      --border: #2d3748; /* softer border color */
      --accent-1: rgb(255,165,120); /* warm orange */
      --accent-2: rgb(120,200,255); /* cyan blue */
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-bg: var(--surface-1);
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
      --header-color: rgb(255,165,120);
      --pad: 12px;
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
      --header-bg: #000;
      --header-color: var(--accent-1);
      --panel-width: 700px;
      --panel-min-width: 280px;
      --panel-max-width: 1100px;
      --histogram-panel-width: 900px;
      --histogram-height-min: 300px;
      --histogram-height-max: 500px;
      --histogram-height-ratio: 0.4;
      --highlight-bg: rgba(255, 165, 120, 0.2);
      --highlight-text: var(--accent-1);
    }

    body {
      background-color: var(--surface-0);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      color: var(--text-primary);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
    }

    h1 {
      font-size: 32px;
      margin: 0;
      color: var(--header-color);
    }

    .dropdown {
      position: relative;
    }

    /* Panel styling to match input panel */
    .wrap{ display:flex; justify-content:center; padding:clamp(6px,2vh,12px); }
    .card{
      width:min(980px, 100%);
      background:var(--surface-1);
      border-radius:var(--panel-radius);
      box-shadow:var(--panel-shadow);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .card-head{ background: transparent; color:var(--header-color); padding:12px 16px; font-weight:600; font-size:1.2rem; letter-spacing:.3px }
    .card-body{ padding:var(--pad); max-height:calc(100vh - 80px); overflow-y:auto; display: flex; flex-direction: column; }
    
    /* Dropdown styling for header */
    .dropdown-container { position: relative; }
    .dropdown-content { 
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 250px;
      z-index: 1000;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--panel-shadow);
      padding: 8px 0;
      margin-top: 4px;
    }
    .dropdown-content.show { display: block; }
    
    /* Dropdown button with 3D effect and animated glow */
    .dropdown-btn {
      position: relative;
      transition: all 0.3s ease;
      animation: subtle-glow 3s ease-in-out infinite;
      background: linear-gradient(145deg, #4a5568, #2d3748) !important;
      border: 1px solid #4a5568 !important;
      box-shadow: 
        0 4px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
      border-radius: 8px !important;
      font-weight: 600;
      color: #e2e8f0 !important;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    @keyframes subtle-glow {
      0%, 100% {
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.3),
          0 0 5px rgba(255, 165, 120, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      }
      50% {
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.3),
          0 0 15px rgba(255, 165, 120, 0.5), 
          0 0 25px rgba(255, 165, 120, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      }
    }

    .dropdown-btn:hover { 
      background: linear-gradient(145deg, #5a6578, #3d4758) !important;
      box-shadow: 
        0 6px 12px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(255, 165, 120, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.15),
        inset 0 -1px 0 rgba(0, 0, 0, 0.25) !important;
      transform: translateY(-1px);
      animation: none;
    }
    
    .dropdown-btn:active {
      background: linear-gradient(145deg, #2d3748, #4a5568) !important;
      box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.4),
        inset 0 2px 4px rgba(0, 0, 0, 0.3),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05) !important;
      transform: translateY(1px);
    }

    .dropdown-arrow { transition: transform 0.3s ease; }
    .dropdown-btn.open .dropdown-arrow { transform: rotate(180deg); }

    /* Analysis option styling in dropdown */
    .analysis-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 4px;
      margin: 2px 8px;
    }

    .analysis-option:hover {
      background: var(--surface-2);
      color: var(--accent-1);
    }

    .analysis-option.active {
      background: var(--surface-2);
      color: var(--accent-1);
      font-weight: 600;
    }

    .option-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .option-text {
      font-size: 14px;
    }

    .dropdown-separator {
      height: 1px;
      background: var(--border);
      margin: 8px 12px;
    }

    .panel-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px;
    }

    /* Ensure only awaiting panel uses panel-row behavior */
    .panel-row:not(#awaiting-panel) {
      display: none;
    }

    /* Special styling for awaiting panel to take full height */
    #awaiting-panel {
      min-height: calc(100vh - 200px);
    }

    .panel {
      background-color: var(--surface-1);
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--border);
      flex: 0 0 auto;
      min-width: var(--panel-min-width);
      max-width: var(--panel-max-width);
      display: flex;
      flex-direction: column;
    }

    .panel-heading {
      background: transparent;
      color: var(--header-color);
      font-weight: 600;
      padding: 8px 16px 6px 16px;
      font-size: 1.1rem;
      letter-spacing: .3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body {
      padding: 8px;
      background: var(--surface-2);
      border-radius: 6px;
      border: 1px solid var(--border);
      margin: 8px 12px 12px 12px;
      flex: 1;
    }

    /* Results container layout - vertical stacking */
    .results-container {
      display: none;
      flex-direction: column;
      gap: 8px;
      height: calc(100vh - 160px);
      overflow: hidden;
      padding: 8px 0;
    }
    
    .results-container.show {
      display: flex !important;
    }

    /* Override panel styles within results container */
    .results-container .panel {
      flex-shrink: 0;
      min-width: auto;
      max-width: none;
    }

    /* Box plot specific chart styling */
    .highcharts-container {
      border-radius: 8px;
      overflow: hidden;
    }
    
    #withOutliers, #withoutOutliers {
      width: 100%;
      height: 280px;
      margin-bottom: 8px;
      min-height: 280px;
      position: relative;
      visibility: visible;
      opacity: 1;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    
    .chart-panel {
      margin-bottom: 8px;
    }
    
    .chart-panel:last-child {
      margin-bottom: 0;
    }

    /* Animations for awaiting data state */
    @keyframes pulse-glow {
      0%, 100% {
        transform: scale(1);
        opacity: 0.7;
        filter: drop-shadow(0 0 5px var(--accent-1));
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
        filter: drop-shadow(0 0 15px var(--accent-1));
      }
    }

    @keyframes button-pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(255, 165, 120, 0.3);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 165, 120, 0.5);
      }
    }

    .loading-dots::after {
      content: '';
      animation: loading-dots 1.5s steps(4, end) infinite;
    }

    @keyframes loading-dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* Ensure panels have flexible height */
    .panel {
      display: flex;
      flex-direction: column;
    }

    .panel-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Only awaiting panel needs full height */
    #awaiting-panel .panel {
      height: 100%;
    }

    @media (max-width: 768px) {
      .panel {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card" role="main">
      <div class="card-head" style="display: flex; align-items: center; justify-content: space-between;">
        <div style="flex: 0 0 auto;">Results Panel</div>
        <div style="flex: 1; text-align: center;">
          <div id="selectedAnalysisTitle" style="font-size: 1.4rem; font-weight: 700; color: var(--accent-1); margin-bottom: 4px;">Box Plot Analysis</div>
          <div id="variableNameDisplay" style="font-size: 1rem; font-weight: 500; color: var(--text-secondary); font-style: italic;">Variable Name</div>
        </div>
        <div style="flex: 0 0 auto;">
          <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleAnalysisDropdown()">
              Advanced Analysis Options
              <div class="dropdown-arrow" style="display: inline-block; margin-left: 8px;">â–¼</div>
            </button>
            
            <div class="dropdown-content" id="analysisDropdown">
              <div class="analysis-option" data-case="Case00" data-base-name="Interactive Histogram" onclick="selectAnalysis('Case00', 'Interactive Histogram', this)">
                <div class="option-icon">ðŸ“ˆ</div>
                <div class="option-text">Interactive Histogram</div>
              </div>
              <div class="analysis-option active" data-case="Case10" data-base-name="Box Plot Analysis" onclick="selectAnalysis('Case10', 'Box Plot Analysis', this)">
                <div class="option-icon">ðŸ“¦</div>
                <div class="option-text">Box Plot Analysis</div>
              </div>
              <div class="analysis-option" data-case="Case20" data-base-name="Cumulative Distribution" onclick="selectAnalysis('Case20', 'Cumulative Distribution', this)">
                <div class="option-icon">ðŸ“ˆ</div>
                <div class="option-text">Cumulative Distribution</div>
              </div>
              <div class="dropdown-separator"></div>
              <div class="analysis-option" data-case="Case30" data-base-name="Percentiles" onclick="selectAnalysis('Case30', 'Percentiles', this)">
                <div class="option-icon">ðŸ“Š</div>
                <div class="option-text">Percentiles</div>
              </div>
              <div class="analysis-option" data-case="Case40" data-base-name="Outliers Detection" onclick="selectAnalysis('Case40', 'Outliers Detection', this)">
                <div class="option-icon">ðŸŽ¯</div>
                <div class="option-text">Outliers Detection</div>
              </div>
              <div class="dropdown-separator"></div>
              <div class="analysis-option" data-case="Case50" data-base-name="Tests of Normality" onclick="selectAnalysis('Case50', 'Tests of Normality', this)">
                <div class="option-icon">ðŸ“Š</div>
                <div class="option-text">Tests of Normality</div>
              </div>
              <div class="analysis-option" data-case="Case60" data-base-name="PP-QQ Plots" onclick="selectAnalysis('Case60', 'PP-QQ Plots', this)">
                <div class="option-icon">ðŸ“ˆ</div>
                <div class="option-text">PP-QQ Plots</div>
              </div>
              <div class="analysis-option" data-case="Case70" data-base-name="Hypothesis Testing" onclick="selectAnalysis('Case70', 'Hypothesis Testing', this)">
                <div class="option-icon">ðŸ“Š</div>
                <div class="option-text">Hypothesis Testing</div>
              </div>
              <div class="analysis-option" data-case="Case90" data-base-name="Confidence Intervals" onclick="selectAnalysis('Case90', 'Confidence Intervals', this)">
                <div class="option-icon">ðŸ“Š</div>
                <div class="option-text">Confidence Intervals</div>
              </div>
              <div class="analysis-option" data-case="Case100" data-base-name="Kernel Density" onclick="selectAnalysis('Case100', 'Kernel Density', this)">
                <div class="option-icon">ðŸ“ˆ</div>
                <div class="option-text">Kernel Density</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">

<!-- Awaiting data panel - shown initially -->


<!-- Results container - hidden initially -->
<div class="results-container" id="results-container">
        <div class="chart-panel">
          <div class="panel">
            <div class="panel-heading">
              Box Plot with Outliers
              <span style="margin-left: auto;">
                <i class="fas fa-expand"></i>
              </span>
            </div>
            <div class="panel-body">
              <div id="withOutliers"></div>
            </div>
          </div>
        </div>
        
        <div class="chart-panel">
          <div class="panel">
            <div class="panel-heading">
              Box Plot Without Outliers
              <span style="margin-left: auto;">
                <i class="fas fa-expand"></i>
              </span>
            </div>
            <div class="panel-body">
              <div id="withoutOutliers"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
    </section>
  </div>
   <script>
    function buildStatLabelSeries(data, labelColor = '#ffa578') {
  // data: [{ boxWithOutliers:[low,q1,med,q3,high], boxWithoutOutliers:[...]}]
  // We only have 1 category, so x = 0
  const makeSeries = (arr) => {
    const labels = [
      { key:'Min',    y: arr[0], dx:  10 },
      { key:'Q1',     y: arr[1], dx:  10 },
      { key:'Median', y: arr[2], dx: -10, align:'right' },
      { key:'Q3',     y: arr[3], dx:  10 },
      { key:'Max',    y: arr[4], dx:  10 }
    ];
    return labels.map(l => ({
      x: 0, y: l.y,
      dataLabels: {
        enabled: true,
        formatter() { return `${l.key}: ${this.y.toFixed(1)}`; },
        style: { color: labelColor, fontSize: '10px', fontWeight: 600 },
        align: l.align || 'left',
        verticalAlign: 'middle',
        x: l.dx,  // small horizontal nudge (chart is inverted)
        y: 0,
        padding: 2,
        backgroundColor: 'rgba(0,0,0,0.3)',
        borderRadius: 3
      }
    }));
  };
  return {
    withOutliers: makeSeries(data[0].boxWithOutliers),
    withoutOutliers: makeSeries(data[0].boxWithoutOutliers)
  };
}



    </script>
  <script>
    function processData(jsonData) {
      const processedData = jsonData.map(item => {
        const values = item.values.slice().sort((a, b) => a - b);
        const n = values.length;
        const low = values[0];
        const high = values[n - 1];
        const median = (values[Math.floor((n - 1) / 2)] + values[Math.ceil((n - 1) / 2)]) / 2;
        const q1 = (values[Math.floor((n - 1) / 4)] + values[Math.ceil((n - 1) / 4)]) / 2;
        const q3 = (values[Math.floor((3 * (n - 1)) / 4)] + values[Math.ceil((3 * (n - 1)) / 4)]) / 2;
        const iqr = q3 - q1;
        const lowerFence = q1 - 1.5 * iqr;
        const upperFence = q3 + 1.5 * iqr;
        const outliers = values.filter(v => v < lowerFence || v > upperFence);
        const adjustedLow = values.find(v => v >= lowerFence);
        const adjustedHigh = [...values].reverse().find(v => v <= upperFence);
        return {
          boxWithOutliers: [low, q1, median, q3, high],
          boxWithoutOutliers: [adjustedLow, q1, median, q3, adjustedHigh],
          outliers
        };
      });
      renderCharts(processedData);
      
      // Update the title with sample size
      updateTitleWithSampleSize(jsonData[0].values.length);
    }
    
    function updateTitleWithSampleSize(sampleSize) {
      const variableNameDisplay = document.getElementById('variableNameDisplay');
      if (variableNameDisplay && window.currentVariableName) {
        variableNameDisplay.textContent = `${window.currentVariableName} (n=${sampleSize})`;
        console.log('âœ… Updated title with sample size:', `${window.currentVariableName} (n=${sampleSize})`);
      }
    }

    function renderCharts(data) {
      console.log('Rendering charts with data:', data);
      
      try {
        // Check if containers exist
        if (!document.getElementById('withOutliers')) {
          console.error('Container "withOutliers" not found');
          return;
        }
        if (!document.getElementById('withoutOutliers')) {
          console.error('Container "withoutOutliers" not found');
          return;
        }
        
        // Check if Highcharts is loaded
        if (typeof Highcharts === 'undefined') {
          console.error('Highcharts library not loaded');
          return;
        }
        
        console.log('Creating first chart (with outliers)...');
        console.log('Chart container element:', document.getElementById('withOutliers'));
        console.log('Container dimensions:', {
          width: document.getElementById('withOutliers')?.offsetWidth,
          height: document.getElementById('withOutliers')?.offsetHeight,
          visible: document.getElementById('withOutliers')?.offsetParent !== null
        });
        
        const variableName = window.currentVariableName || 'Variable';
        const statLabels = buildStatLabelSeries(data);
      Highcharts.chart('withOutliers', {
          chart: { 
            type: 'boxplot', 
            inverted: true,
            backgroundColor: 'transparent',
            height: 280,
            marginTop: 40,
            marginBottom: 50,
            marginLeft: 80,
            marginRight: 20
          },
          title: { 
            text: `With Outliers`,
            style: { color: '#ffffff', fontSize: '13px' },
            margin: 15
          },
          xAxis: {
            categories: [variableName],
            labels: { style: { color: '#ffffff', fontSize: '11px' } },
            gridLineColor: 'rgba(255,255,255,0.1)',
            title: {
              text: 'Distribution',
              style: { color: '#ffffff', fontSize: '11px' }
            }
          },
          yAxis: {
            labels: { style: { color: '#ffffff', fontSize: '11px' } },
            gridLineColor: 'rgba(255,255,255,0.1)',
            title: { 
              text: 'Values',
              style: { color: '#ffffff', fontSize: '11px' }
            }
          },
          legend: {
            enabled: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            style: { color: '#ffffff' },
            formatter: function() {
              const point = this.point;
              return `<b>${variableName}</b><br/>` +
                     `Min: ${point.low}<br/>` +
                     `Q1: ${point.q1}<br/>` +
                     `Median: ${point.median}<br/>` +
                     `Q3: ${point.q3}<br/>` +
                     `Max: ${point.high}`;
            }
          },
          plotOptions: {
            boxplot: {
              dataLabels: {
                enabled: false
              },
              fillColor: 'rgba(255, 255, 255, 0.1)',
              lineWidth: 2,
              medianColor: '#ffffff',
              medianWidth: 3,
              stemColor: '#ffffff',
              stemWidth: 1,
              whiskerColor: '#ffffff',
              whiskerWidth: 2
            }
          },
          series: [
            { 
              name: 'Box Plot', 
              data: data.map(d => d.boxWithOutliers),
              color: '#e94560'
            },
            {
              name: 'Stats',
              type: 'scatter',
              data: statLabels.withOutliers,
              marker: { enabled: false },
              enableMouseTracking: false,
              tooltip: { enabled: false },
              showInLegend: false
            }
          ]
        });

        console.log('Creating second chart (without outliers)...');
      Highcharts.chart('withoutOutliers', {
          chart: { 
            type: 'boxplot', 
            inverted: true,
            backgroundColor: 'transparent',
            height: 280,
            marginTop: 40,
            marginBottom: 50,
            marginLeft: 80,
            marginRight: 20
          },
          title: { 
            text: `Without Outliers + Outlier Points`,
            style: { color: '#ffffff', fontSize: '13px' },
            margin: 15
          },
          xAxis: {
            categories: [variableName],
            labels: { style: { color: '#ffffff', fontSize: '11px' } },
            gridLineColor: 'rgba(255,255,255,0.1)',
            title: {
              text: 'Distribution',
              style: { color: '#ffffff', fontSize: '11px' }
            }
          },
          yAxis: {
            labels: { style: { color: '#ffffff', fontSize: '11px' } },
            gridLineColor: 'rgba(255,255,255,0.1)',
            title: { 
              text: 'Values',
              style: { color: '#ffffff', fontSize: '11px' }
            }
          },
          legend: {
            enabled: true,
            align: 'right',
            verticalAlign: 'top',
            layout: 'vertical',
            x: -10,
            y: 20,
            itemStyle: { color: '#ffffff', fontSize: '10px' },
            itemMarginBottom: 2
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            style: { color: '#ffffff' }
          },
          plotOptions: {
            boxplot: {
              dataLabels: {
                enabled: false
              },
              fillColor: 'rgba(255, 255, 255, 0.1)',
              lineWidth: 2,
              medianColor: '#ffffff',
              medianWidth: 3,
              stemColor: '#ffffff',
              stemWidth: 1,
              whiskerColor: '#ffffff',
              whiskerWidth: 2
            },
            scatter: {
              dataLabels: {
                enabled: false
              }
            }
          },
        series: [
            { 
              name: 'Box Plot', 
              data: data.map(d => d.boxWithoutOutliers),
              color: '#00bcd4',
              tooltip: {
                pointFormatter: function() {
                  return `<b>${variableName}</b><br/>` +
                         `Min: ${this.low}<br/>` +
                         `Q1: ${this.q1}<br/>` +
                         `Median: ${this.median}<br/>` +
                         `Q3: ${this.q3}<br/>` +
                         `Max: ${this.high}`;
                }
              }
            },
            {
              name: `Outliers (${data.reduce((sum, d) => sum + d.outliers.length, 0)})`,
            type: 'scatter',
            data: data.flatMap((d, i) => d.outliers.map(v => [i, v])),
              marker: { radius: 3 },
              color: '#ff6b6b',
              tooltip: {
                pointFormat: 'Outlier: <b>{point.y}</b>'
              }
            },
            {
              name: 'Stats',
              type: 'scatter',
              data: statLabels.withoutOutliers,
              marker: { enabled: false },
              enableMouseTracking: false,
              tooltip: { enabled: false },
              showInLegend: false
          }
        ]
      });
        
        console.log('Charts rendered successfully');
        
        // Force container visibility and resize
        setTimeout(() => {
          const containers = ['withOutliers', 'withoutOutliers'];
          containers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
              container.style.visibility = 'visible';
              container.style.opacity = '1';
              console.log(`âœ… Forced visibility for ${id}`);
            }
          });
          
          // Trigger Highcharts reflow to ensure proper sizing
          if (window.Highcharts && window.Highcharts.charts) {
            window.Highcharts.charts.forEach(chart => {
              if (chart) {
                chart.reflow();
                console.log('âœ… Chart reflow triggered');
              }
            });
          }
        }, 100);
        
      } catch (error) {
        console.error('Error rendering charts:', error);
      }
    }

    window.populateBoxPlot = function(jsonString) {
      console.log('populateBoxPlot called with:', jsonString);
      try {
        const parsed = JSON.parse(jsonString);
        console.log('Parsed data:', parsed);
        
        // Update variable name if available
        if (parsed.title || parsed.variableName) {
          updateVariableName(parsed.title || parsed.variableName);
        }
        
        if (!Array.isArray(parsed.values)) throw new Error('Invalid format - expected values array');
        
        // Hide awaiting panel and show results container
        const awaitingPanel = document.getElementById("awaiting-panel");
        const resultsContainer = document.getElementById("results-container");
        
        console.log('Showing/hiding panels...', {awaitingPanel, resultsContainer});
        
        if (awaitingPanel) {
          awaitingPanel.style.display = "none";
          console.log('âœ… Awaiting panel hidden');
        }
        if (resultsContainer) {
          resultsContainer.style.display = "flex";
          resultsContainer.classList.add("show");
          console.log('âœ… Results container shown');
        }
        
        // Update title with sample size
        updateTitleWithSampleSize(parsed.values.length);
        
        processData([parsed]);
      } catch (e) {
        console.error('Error parsing input JSON:', e.message);
        console.error('Raw data:', jsonString);
      }
    };

    // Alias function for VB6 compatibility - populateHistogram calls populateBoxPlot
    window.populateHistogram = function(jsonString) {
      console.log('populateHistogram called (redirecting to populateBoxPlot):', jsonString);
      return window.populateBoxPlot(jsonString);
    };

    // Test function to verify charts are working
    window.testBoxPlot = function() {
      console.log('Running test with sample data...');
      const testData = {
        title: "Test Data",
        values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20, 25, 30, 100]
      };
      window.populateBoxPlot(JSON.stringify(testData));
    };

    // Function to toggle dropdown visibility - EXACT COPY FROM HISTOGRAM
    window.toggleAnalysisDropdown = function() {
      const dropdown = document.getElementById('analysisDropdown');
      const btn = document.querySelector('.dropdown-btn');
      
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
        btn.classList.remove('open');
      } else {
        dropdown.classList.add('show');
        btn.classList.add('open');
      }
    };

    // Function to select analysis type - Enhanced for better switching
    window.selectAnalysis = function(caseCode, analysisName, element) {
      console.log('ðŸ”„ Switching analysis:', analysisName, caseCode);
      
      // Update active state for all options
      document.querySelectorAll('.analysis-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // Set the selected option as active
      element.classList.add('active');
      
      // Update the center title with just the analysis name (no variable name)
      const selectedTitleElement = document.getElementById('selectedAnalysisTitle');
      if (selectedTitleElement) {
        selectedTitleElement.textContent = analysisName;
      }
      
      // Update variable name display if it exists
      const variableNameDisplay = document.getElementById('variableNameDisplay');
      if (variableNameDisplay && window.currentVariableName) {
        variableNameDisplay.textContent = window.currentVariableName;
      }
      
      // Close dropdown
      const dropdown = document.getElementById('analysisDropdown');
      const btn = document.querySelector('.dropdown-btn');
      if (dropdown && btn) {
        dropdown.classList.remove('show');
        btn.classList.remove('open');
      }
      
      // Enhanced VB6 communication with better logging
      console.log(`ðŸ“¤ Sending switch request to VB6: ${caseCode} -> ${analysisName}`);
      sendMessageToVB6(caseCode, analysisName);
      
      // Special handling for histogram switch (Case00)
      if (caseCode === 'Case00') {
        console.log('ðŸ”„ Switching to Interactive Histogram...');
        // VB6 will handle loading the histogram HTML
      } else if (caseCode === 'Case10') {
        console.log('ðŸ“¦ Staying on Box Plot Analysis...');
        // Already on box plot, no change needed
      } else {
        console.log(`ðŸ“Š Switching to ${analysisName}...`);
        // VB6 will handle loading the appropriate HTML for other analyses
      }
    };

    // Function to update variable name display - EXACT COPY FROM HISTOGRAM
    window.updateVariableName = function(variableName) {
      // Store the variable name globally
      window.currentVariableName = variableName || 'Variable';
      
      console.log('Updating variable name to:', window.currentVariableName);
      
      // Update page title
      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        pageTitle.textContent = `${window.currentVariableName} - Box Plot Analysis`;
      }
      
      // Update center title with current analysis (no variable name)
      const selectedTitleElement = document.getElementById('selectedAnalysisTitle');
      const activeOption = document.querySelector('.analysis-option.active');
      
      if (selectedTitleElement && activeOption) {
        const analysisName = activeOption.getAttribute('data-base-name') || activeOption.querySelector('.option-text').textContent;
        selectedTitleElement.textContent = analysisName;
      } else if (selectedTitleElement) {
        selectedTitleElement.textContent = 'Box Plot Analysis';
      }
      
      // Update the variable name display under the title
      const variableNameDisplay = document.getElementById('variableNameDisplay');
      if (variableNameDisplay) {
        variableNameDisplay.textContent = window.currentVariableName;
        console.log('âœ… Variable name display updated to:', window.currentVariableName);
      }
    };

    // Note: sendMessageToVB6 function is injected by VB6 via AddScriptToExecuteOnDocumentCreated
    // VB6 creates: function sendMessageToVB6(action, data) { if(window.external && window.external.OrdoWebView1_JSMessage) window.external.OrdoWebView1_JSMessage(action + '|' + data); }
    // This function is used directly in dropdown onclick handlers

    // Function to toggle dropdown visibility
    window.toggleAnalysisDropdown = function() {
        const dropdown = document.getElementById('analysisDropdown');
        const btn = document.querySelector('.dropdown-btn');
        
        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
            btn.classList.remove('open');
        } else {
            dropdown.classList.add('show');
            btn.classList.add('open');
        }
    };

    // Function to select analysis type
    window.selectAnalysis = function(caseCode, analysisName, element) {
        console.log('Selecting analysis:', analysisName, caseCode);
        
        // Update active state for all options
        document.querySelectorAll('.analysis-option').forEach(option => {
            option.classList.remove('active');
        });
        
        // Set the selected option as active
        element.classList.add('active');
        
        // Update the center title with just the analysis name (no variable name)
        const selectedTitleElement = document.getElementById('selectedAnalysisTitle');
        if (selectedTitleElement) {
            selectedTitleElement.textContent = analysisName;
        }
        
        // Close dropdown
        const dropdown = document.getElementById('analysisDropdown');
        const btn = document.querySelector('.dropdown-btn');
        if (dropdown && btn) {
            dropdown.classList.remove('show');
            btn.classList.remove('open');
        }
        
        // Send message to VB6 using VB6 injected function
        sendMessageToVB6(caseCode, caseCode);
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown-container')) {
        const dropdown = document.getElementById('analysisDropdown');
        const btn = document.querySelector('.dropdown-btn');
        if (dropdown && btn) {
          dropdown.classList.remove('show');
          btn.classList.remove('open');
        }
      }
    });

    // IMMEDIATE function exposure (before DOMContentLoaded)
    console.log('ðŸš€ Exposing functions immediately...');
    
    // Ensure populateHistogram is available immediately
    if (typeof window.populateHistogram === 'undefined') {
      window.populateHistogram = function(jsonString) {
        console.log('ðŸ”„ populateHistogram called immediately (redirecting to populateBoxPlot):', jsonString);
        return window.populateBoxPlot(jsonString);
      };
      console.log('âœ… populateHistogram exposed immediately');
    }
    
    // Ensure populateBoxPlot is available immediately
    if (typeof window.populateBoxPlot === 'undefined') {
      window.populateBoxPlot = function(jsonString) {
        console.log('ðŸ“¦ populateBoxPlot called immediately:', jsonString);
        try {
          const parsed = JSON.parse(jsonString);
          console.log('Parsed data:', parsed);
          
          if (parsed.title || parsed.variableName) {
            if (typeof updateVariableName === 'function') {
              updateVariableName(parsed.title || parsed.variableName);
            }
          }
          
          if (!Array.isArray(parsed.values)) throw new Error('Invalid format - expected values array');
          
          const awaitingPanel = document.getElementById("awaiting-panel");
          const resultsContainer = document.getElementById("results-container");
          
          if (awaitingPanel) awaitingPanel.style.display = "none";
          if (resultsContainer) resultsContainer.style.display = "flex";
          
          processData([parsed]);
        } catch (e) {
          console.error('Error parsing input JSON:', e.message);
          console.error('Raw data:', jsonString);
        }
      };
      console.log('âœ… populateBoxPlot exposed immediately');
    }
    
    console.log('ðŸŽ¯ All functions exposed. Testing availability:');
    console.log('- populateHistogram:', typeof window.populateHistogram);
    console.log('- populateBoxPlot:', typeof window.populateBoxPlot);

    // Debug: Log available functions on page load
    window.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸ” Box Plot page loaded. Available functions:');
      console.log('- populateHistogram:', typeof window.populateHistogram);
      console.log('- populateBoxPlot:', typeof window.populateBoxPlot);
      console.log('- testBoxPlot:', typeof window.testBoxPlot);
      console.log('- toggleAnalysisDropdown:', typeof window.toggleAnalysisDropdown);
      console.log('- selectAnalysis:', typeof window.selectAnalysis);
      console.log('- updateVariableName:', typeof window.updateVariableName);
      
      // Test that functions are callable
      try {
        if (typeof window.populateHistogram === 'function') {
          console.log('âœ… populateHistogram function is available and callable');
        } else {
          console.error('âŒ populateHistogram function is NOT available');
        }
        
        if (typeof window.populateBoxPlot === 'function') {
          console.log('âœ… populateBoxPlot function is available and callable');
        } else {
          console.error('âŒ populateBoxPlot function is NOT available');
        }
      } catch (error) {
        console.error('Error testing functions:', error);
      }
    });

    // Auto-test on page load if no data is provided within 1 seconds (faster for debugging)
    setTimeout(() => {
      if (!document.querySelector('#withOutliers .highcharts-container')) {
        console.log('No charts detected after 1 second, running auto-test...');
        window.testBoxPlot();
      }
    }, 1000);
    
    // Additional global exposure for debugging
    window.debugBoxPlot = function() {
      console.log('ðŸ› Debug info:');
      console.log('Current functions available:', Object.keys(window).filter(key => key.includes('populate') || key.includes('BoxPlot')));
      console.log('DOM ready state:', document.readyState);
      console.log('Highcharts loaded:', typeof Highcharts !== 'undefined');
    };
    
    // Force expose functions globally (redundant but ensures availability)
    if (typeof window.populateHistogram === 'undefined') {
      console.warn('Re-defining populateHistogram function...');
      window.populateHistogram = function(jsonString) {
        console.log('populateHistogram called (redirecting to populateBoxPlot):', jsonString);
        return window.populateBoxPlot(jsonString);
      };
    }
    
    if (typeof window.populateBoxPlot === 'undefined') {
      console.warn('Re-defining populateBoxPlot function...');
      window.populateBoxPlot = function(jsonString) {
        console.log('populateBoxPlot called with:', jsonString);
        try {
          const parsed = JSON.parse(jsonString);
          console.log('Parsed data:', parsed);
          
          if (parsed.title || parsed.variableName) {
            updateVariableName(parsed.title || parsed.variableName);
          }
          
          if (!Array.isArray(parsed.values)) throw new Error('Invalid format - expected values array');
          
          const awaitingPanel = document.getElementById("awaiting-panel");
          const resultsContainer = document.getElementById("results-container");
          
          if (awaitingPanel) awaitingPanel.style.display = "none";
          if (resultsContainer) resultsContainer.style.display = "flex";
          
          // Update title with sample size
          if (typeof updateTitleWithSampleSize === 'function') {
            updateTitleWithSampleSize(parsed.values.length);
          }
          
          processData([parsed]);
        } catch (e) {
          console.error('Error parsing input JSON:', e.message);
          console.error('Raw data:', jsonString);
        }
      };
    }


</script>
</body>
</html>
